<!DOCTYPE html>
<html>
<head>
    <title>GitHup</title>
    <link href="style.css" rel="stylesheet"/>
</head>
<body>
<h2>CSS3 Timeline</h2>

<p>Please set the $vertical variable to false to see the horizontal version.</p>
<ul id='timeline'>
</ul>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="jquery.mousewheel.js"></script>
<script src="jquery.scrollintoview.js"></script>
<script src="jquery.waypoints.js"></script>
<script src="http://builds.handlebarsjs.com.s3.amazonaws.com/handlebars-v1.3.0.js"></script>
<script>
    function shuffle(o) { //v1.0
        for (var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
        return o;
    }
    var postTemplate = "<li class='work'>\
            <input class='radio' id='{{hash}}' name='works' type='radio'>\
            <div class='relative'>\
            <label for='{{hash}}'>{{message}}</label>\
    <span class='date'>{{time}} hours ago</span>\
    <span class='circle'></span>\
    </div>\
    <div class='content'>\
            <p>\
            <a href='{{author.url}}'>\
            <img class='img-responsive pull-right icon-64' alt='{{author.username}}' src='{{author.imageUrl}}'/>\
            </a>\
    <a href='{{author.url}}'>{{author.username}}</a> pushed to <a href='{{repo.url}}'>{{repo.name}}</a>\
    <br>\
    <a href='{{url}}'>{{ hash }}</a>\
    </p></div></li>";
    var template = Handlebars.compile(postTemplate);
    var $tl = $('#timeline');
    var activatedPos = null;
    var busy = false;

    var freeCB = function () {
        setTimeout(function () {
            busy = false;
        }, 180);
    };

    function activate($el) {
        $('.active').removeClass('active');
        $el.addClass('active').scrollintoview({direction: 'horizontal', 'complete': freeCB});
        activatedPos = $el.index(); // TODO this line is potentially confusing
    }
    function activateId(position) {
        return activate($tl.find('li').eq(position));
    }

    $("body").mousewheel(function (event, delta) {
        if (busy) {
            return event.preventDefault();
        }
        busy = true;
        if (activatedPos === null) {
            newPos = 0;
        }
        else {
            if (delta > 0) {
                newPos = activatedPos - 1;
            }
            else {
                newPos = activatedPos + 1;
            }
        }
        console.log("newPos is %d", newPos);
        if (newPos >= 0 && newPos < $('li').length) {
            activateId(newPos);
        }
        else {
            busy = false;
        }
//        this.scrollLeft -= (delta * 30);
        event.preventDefault();

    });

    var activateCb = function () {
        activate($(this));
    };

    $('li').click(activateCb);

    //    $('li').waypoint(activateCb, {horizontal:true, offset:'bottom-in-view'});

    $.getJSON('http://cloud.rozu.co:9080/githup', function (result) {
        data = shuffle(result);
        var time = 2;
        for (var i = 0; i < data.length; i++) {
            if (Math.random() > 0.9) {
                time++;
            }
            var datum = data[i];

            repoUrl = datum.url.split('/compare/')[0];
            repoName = repoUrl.split('https://github.com/')[1];
            datum.repo = {name: repoName, url: repoUrl};
            datum.hash = datum.url.split('...')[1];
            datum.time = time;

            var html = template(datum);
            $('#timeline').append(html);
        }
    });


</script>
</body>
</html>